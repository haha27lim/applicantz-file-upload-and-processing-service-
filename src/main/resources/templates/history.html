<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing History Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

</head>

<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">

                <div class="text-center mb-4">
                    <h1 class="display-4">Processing History</h1>
                    <p class="lead">Overview of all file processing activities</p>
                </div>

                <!-- Statistics Overview -->
                <div class="statistics-overview" th:if="${statistics}"
                    style="border:2px solid darkblue; border-radius: 15px; padding:30px; margin-bottom:30px;">
                    <h4 class="mb-4">Overall Statistics</h4>
                    <div class="row">
                        <div class="col-md-2 col-sm-4 col-6">
                            <div class="stat-item" style="text-align: center; padding:15px;">
                                <span class="stat-number" th:text="${statistics.totalFiles}">0</span>
                                <h5 class="stat-label">Total Files</h5>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6">
                            <div class="stat-item" style="text-align: center; padding:15px;">
                                <span class="stat-number" th:text="${statistics.successfulFiles}">0</span>
                                <h5 class="stat-label">Successful</h5>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6">
                            <div class="stat-item" style="text-align: center; padding:15px;">
                                <span class="stat-number" th:text="${statistics.failedFiles}">0</span>
                                <h5 class="stat-label">Failed</h5>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6">
                            <div class="stat-item" style="text-align: center; padding:15px;">
                                <span class="stat-number"
                                    th:text="${#numbers.formatInteger(statistics.totalLines, 0, 'COMMA')}">0</span>
                                <h5 class="stat-label">Total Lines</h5>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6">
                            <div class="stat-item" style="text-align: center; padding:15px;">
                                <span class="stat-number"
                                    th:text="${#numbers.formatInteger(statistics.totalWords, 0, 'COMMA')}">0</span>
                                <h5 class="stat-label">Total Words</h5>
                            </div>
                        </div>
                        <div class="col-md-2 col-sm-4 col-6">
                            <div class="stat-item" style="text-align: center; padding:15px;">
                                <span class="stat-number"
                                    th:text="${statistics.totalFiles > 0 ? #numbers.formatDecimal((statistics.successfulFiles * 100.0) / statistics.totalFiles, 1, 1) + '%' : '0%'}">0%</span>
                                <h5 class="stat-label">Success Rate</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing History Table -->
                <div class="history-table">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">Filename</th>
                                    <th scope="col">Type</th>
                                    <th scope="col">Size</th>
                                    <th scope="col">Lines</th>
                                    <th scope="col">Words</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Processed At</th>
                                    <th scope="col">Download</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="result : ${results}">
                                    <td th:text="${result.id}"></td>
                                    <td th:text="${result.filename}"></td>
                                    <td><span class="badge file-type-badge"
                                            th:classappend="${result.fileType == 'TXT' ? 'bg-primary' : (result.fileType == 'CSV' ? 'bg-success' : 'bg-secondary')}"
                                            th:text="${result.fileType}"></span></td>
                                    <td th:text="${#numbers.formatDecimal(result.fileSize / 1024.0, 1, 2) + ' KB'}">
                                    </td>
                                    <td th:text="${#numbers.formatInteger(result.lineCount, 0, 'COMMA')}"></td>
                                    <td th:text="${#numbers.formatInteger(result.wordCount, 0, 'COMMA')}"></td>
                                    <td>
                                        <i th:if="${result.status.name() == 'SUCCESS'}"
                                            class="fas fa-check-circle status-success"></i>
                                        <i th:if="${result.status.name() == 'FAILED'}"
                                            class="fas fa-times-circle status-failed"></i>
                                        <span th:text="${result.status}"></span>
                                    </td>
                                    <td th:text="${#temporals.format(result.processedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                                    <td>
                                        <div>
                                            <a th:href="@{'/download/' + ${result.id}}" class="btn btn-link p-0 me-2"
                                                title="Download this file" th:if="${result.status.name() == 'SUCCESS'}">
                                                <i class="fas fa-download text-primary"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-link p-0 btn-delete" title="Delete this file"
                                            th:data-file-id="${result.id}" th:data-file-name="${result.filename}">
                                            <i class="fas fa-trash text-danger"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div class="text-center py-5" style="display: none;" id="emptyState">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Processing History</h4>
                    <p class="text-muted">Upload your first file to see processing history here.</p>
                    <a href="/" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload File
                    </a>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <a href="/" class="btn btn-primary btn-lg">
                        <i class="fas fa-upload"></i> Upload New File
                    </a>
                    <button class="btn btn-outline-secondary btn-lg ms-2" onclick="refreshHistory()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="/h2-console" class="btn btn-outline-info btn-lg ms-2" target="_blank">
                        <i class="fas fa-database"></i> Database Console
                    </a>
                </div>

                <!-- Additional Info -->
                <div class="row mt-5">

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Important Notes</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li><i class="fas fa-info"></i> Only .txt and .csv files are supported
                                    </li>
                                    <li><i class="fas fa-info"></i> Maximum file size is 10MB</li>
                                    <li><i class="fas fa-info"></i> Database resets on application restart -
                                        stored in H2 in-memory database
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="confirmText"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="yesButton">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function refreshHistory() {
            location.reload();
        }

        // Refresh every 60 sec
        setInterval(function () {

            console.log('Auto-refresh interval');
        }, 60000);


        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.querySelector('tbody');
            const emptyState = document.getElementById('emptyState');
            const historyTable = document.querySelector('.history-table');

            if (tableBody && tableBody.children.length === 0) {
                historyTable.style.display = 'none';
                emptyState.style.display = 'block';
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const deleteButtons = document.querySelectorAll('.btn-delete');
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const confirmText = document.getElementById('confirmText');
            const yesButton = document.getElementById('yesButton');

            deleteButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const fileId = this.getAttribute('data-file-id');
                    const fileName = this.getAttribute('data-file-name');

                    if (fileId) {
                        confirmText.innerHTML = `Do you want to delete the file: <strong>${fileName}</strong>?`;

                        yesButton.onclick = function () {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/delete/${fileId}`;
                            document.body.appendChild(form);
                            form.submit();
                        };

                        confirmModal.show();
                    } else {
                        console.error('File ID not found');
                    }
                });
            });
        });


    </script>
</body>

</html>